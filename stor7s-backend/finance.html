<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STOR7S | Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Finance)</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
body{font-family:Tajawal;background:#0b1220;color:#fff;margin:0;}
.topbar{background:#101d36;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.btn{background:#3b82f6;border:0;padding:10px 15px;border-radius:8px;color:#fff;cursor:pointer;}
.card{background:#0f1b33;padding:20px;border-radius:12px;margin:10px;}
input,select{width:100%;padding:10px;margin-top:5px;border-radius:8px;background:#162544;color:#fff;border:1px solid #243b55;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);}
</style>
</head>

<body>

<div class="topbar">
  <div>ğŸ’° STOR7S | Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø±Ù‚Ø§Ø¨Ø© ÙÙ‚Ø·)</div>
  <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="card">
  <h3>â• Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ </h3>

  <input id="req_desc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨">
  <input id="req_company" placeholder="Ø§Ù„Ø´Ø±ÙƒØ©">
  <input id="req_branch" placeholder="Ø§Ù„ÙØ±Ø¹">

  <button class="btn" onclick="createRequest()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

  <h2>ğŸ“Š ÙØ­Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
  <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ù…ÙˆØ±Ø¯ / Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" onkeyup="filterData()">
  <button class="btn" onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  <h3>ğŸ§¾ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
<table id="finTable">
  <thead>
    <tr>
      <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
      <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø¹Ø±Ø¶</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

</div>

<script>
const API = "http://localhost:5000/api/finance";

async function loadData(){
  let res = await fetch(API+"/purchases");
  let data = await res.json();

  let rows = "";
  for(let r of data){
    rows += `
    <tr>
      <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}</td>
      <td>${r.Ø§Ù„Ù…ÙˆØ±Ø¯}</td>
      <td>${r.Ø§Ù„Ø³Ø¹Ø±}</td>
      <td>${r.Ø§Ù„ÙØ§ØªÙˆØ±Ø©}</td>
      <td>${r.ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙØ§ØªÙˆØ±Ø©}</td>
      <td>${r.Ø§Ù„Ø­Ø§Ù„Ø©}</td>
      <td>
        <button class="btn" onclick="viewFiles('${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}')">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª</button>
      </td>
    </tr>`;
  }

  document.querySelector("#finTable tbody").innerHTML = rows;
}


function filterData(){
  let q = document.getElementById("search").value.toLowerCase();
  document.querySelectorAll("#finTable tbody tr").forEach(r=>{
    r.style.display = r.textContent.toLowerCase().includes(q) ? "" : "none";
  });
}

function logout(){localStorage.clear();location.reload();}

// ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
loadData();

    async function viewFiles(id){
  let res = await fetch(API+"/attachments/"+id);
  let files = await res.json();

  if(files.length === 0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª");
    return;
  }

  let list = files.map(f =>
    `ğŸ“ ${f.Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù}`
  ).join("\n");

  alert(list);
}

    async function createRequest(){
  const desc = document.getElementById("req_desc").value;
  const company = document.getElementById("req_company").value;
  const branch = document.getElementById("req_branch").value;

  if(!desc){
    alert("âš ï¸ Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨");
    return;
  }

  let res = await fetch(API+"/create-request",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      Ø§Ù„ÙˆØµÙ: desc,
      Ø§Ù„Ø´Ø±ÙƒØ©: company,
      Ø§Ù„ÙØ±Ø¹: branch
    })
  });

  let r = await res.json();
  alert(r.msg);

  document.getElementById("req_desc").value = "";
}

</script>

</body>
</html>
