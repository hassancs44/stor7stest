<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>STOR7S | Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
body{font-family:Tajawal;background:#0b1220;color:#fff;margin:0;}
.topbar{background:#101d36;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.btn{background:#3b82f6;border:0;padding:10px 15px;border-radius:8px;color:#fff;cursor:pointer;}
.btn.red{background:#ef4444;}
.card{background:#0f1b33;padding:20px;border-radius:12px;margin:10px;}
input,select,textarea{width:100%;padding:10px;margin-top:5px;border-radius:8px;background:#162544;color:#fff;border:1px solid #243b55;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);}
</style>
</head>

<body>

<!-- ====================== HEADER ====================== -->
<div class="topbar">
  <div>ğŸ“Œ STOR7S | ØµÙØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</div>
  <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<!-- ====================== Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================== -->
<div class="card">
  <h3>ğŸ” Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯Ùƒ</h3>
  <input id="dept" disabled style="background:#162544;color:#bbb">
  <button class="btn" onclick="loadPending()">Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>

  <table id="tbl">
    <thead>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
        <th>Ø§Ù„Ù‚Ø³Ù…</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ø¹ØªÙ…Ø§Ø¯</th>
        <th>Ø±ÙØ¶</th>
        <th>Ù…Ø±ÙÙ‚Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- ====================== Ø±ÙØ¹ Ø·Ù„Ø¨ ====================== -->
<div class="card">
  <h3>ğŸ“ Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (ÙŠØ¹ØªÙ…Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙŠØ±Ø³Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)</h3>
  <input id="m_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" disabled>
  <input id="m_dept" placeholder="Ø§Ù„Ù‚Ø³Ù…" disabled>
  <input id="m_branch" placeholder="Ø§Ù„ÙØ±Ø¹" disabled>
  <select id="m_type">
    <option>Ù…ÙˆØ§Ø¯</option><option>Ø£Ø¬Ù‡Ø²Ø©</option>
    <option>Ø®Ø¯Ù…Ø§Øª</option><option>ØµÙŠØ§Ù†Ø©</option>
  </select>
  <textarea id="m_desc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨"></textarea>
  <button class="btn" onclick="createReq()">Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨</button>
</div>


<script>
/* ========================== API LINKS ========================== */
const API = "/api/manager";
const EMP = "http://localhost:5000/api/employee"; // Ù„Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù
const PURCH = "http://localhost:5000/api/purchasing";

/* ========================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ========================== */
document.addEventListener("DOMContentLoaded", () => {
  let user = localStorage.getItem("user");
  if(!user){
    alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    location.href = "login.html";
    return;
  }

  user = JSON.parse(user);

  // âœ¨ ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  document.getElementById("dept").value = user.department;
  document.getElementById("m_name").value = user.name;
  document.getElementById("m_dept").value = user.department;
  document.getElementById("m_branch").value = user.branch;

  loadPending(); // ğŸš€ Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
});


/* ========================== Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø³Ù… ========================== */
async function loadPending(){
  let user = JSON.parse(localStorage.getItem("user"));
  let dept = user.department;

  let res = await fetch(`/api/manager/pending/${dept}`);
  let data = await res.json();

  let rows = data.map(r => `
    <tr>
      <td>${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]}</td>
      <td>${r["Ø§Ù„Ù‚Ø³Ù…"]}</td>
      <td>${r["Ø§Ù„Ø­Ø§Ù„Ø©"]}</td>
      <td><button class="btn" onclick="approve(${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]})">âœ”ï¸ Ø§Ø¹ØªÙ…Ø§Ø¯</button></td>
      <td><button class="btn red" onclick="reject(${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]})">âŒ Ø±ÙØ¶</button></td>
      <td><button class="btn" onclick="showAttachments(${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]})">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª</button></td>
    </tr>
  `).join("");

  document.querySelector("#tbl tbody").innerHTML = rows;
}



/* ========================== Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ + ØªØ­ÙˆÙŠÙ„Ù‡ ========================== */
async function approve(id){
  await fetch(`${API}/approve`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨:id})
  });

  alert("âœ”ï¸ ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª");
  loadPending();
}


/* ========================== Ø§Ù„Ø±ÙØ¶ ========================== */
async function reject(id){
  let reason = prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:");
  alert(`âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${id}\nğŸ“Œ Ø§Ù„Ø³Ø¨Ø¨: ${reason}`);
}

/* ========================== Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø¯ÙŠØ± ========================== */
async function createReq(){
  let user = JSON.parse(localStorage.getItem("user"));

  let form = new FormData();
  form.append("Ø§Ù„Ø±Ø§ÙØ¹", user.name);
  form.append("Ø§Ù„Ø¯ÙˆØ±", "Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…");
  form.append("Ø§Ù„Ù‚Ø³Ù…", user.department);
  form.append("Ø§Ù„Ø´Ø±ÙƒØ©", user.company);
  form.append("Ø§Ù„ÙØ±Ø¹", user.branch);
  form.append("Ø§Ù„Ù†ÙˆØ¹", document.getElementById("m_type").value);
  form.append("Ø§Ù„ÙˆØµÙ", document.getElementById("m_desc").value);
  form.append("Ø§Ù„Ø­Ø§Ù„Ø©", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª");

  let res = await fetch("/api/employee/create", {
    method:"POST", body:form
  });

  let data = await res.json();
  alert("ğŸš€ ØªÙ… Ø±ÙØ¹ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: "+ data["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]);
  loadPending();
}


/* ========================== Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ========================== */
async function showAttachments(id){
  let res = await fetch(`http://localhost:5000/api/employee/attachments/${id}`);
  let files = await res.json();

  if(!files.length){
    alert("ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª");
    return;
  }

  let html = files.map(f => `
    ğŸ“„ <a href="/uploads/${f}" target="_blank" style="color:#3b82f6;">
      ${f}
    </a>
  `).join("<br>");

  alert("ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨:\n\n" + html);
}


/* ========================== ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ========================== */
function logout(){ localStorage.clear(); location.href="login.html"; }

</script>

</body>
</html>
