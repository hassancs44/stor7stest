<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>STOR7S | Ø§Ù„Ù…ÙˆØ¸Ù</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
body{font-family:Tajawal;background:#0b1220;color:#fff;margin:0;}
.topbar{background:#101d36;padding:15px;display:flex;justify-content:space-between;}
.btn{background:#3b82f6;border:0;padding:10px 15px;border-radius:8px;color:#fff;cursor:pointer;}
.card{background:#0f1b33;padding:20px;border-radius:12px;margin:10px;}
input,select,textarea{width:100%;padding:10px;margin-top:5px;border-radius:8px;background:#162544;color:#fff;border:1px solid #243b55;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);}
</style>
</head>

<body>

<div class="topbar">
  <div> STOR7S | ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</div>
</div>

<div class="card">
  <h3>Ø±ÙØ¹ Ø·Ù„Ø¨ Ø§Ø­ØªÙŠØ§Ø¬</h3>
  <input id="emp_name"   placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" disabled>
<input id="emp_dept"   placeholder="Ø§Ù„Ù‚Ø³Ù…" disabled>
<input id="emp_comp"   placeholder="Ø§Ù„Ø´Ø±ÙƒØ©" disabled>
<input id="emp_branch" placeholder="Ø§Ù„ÙØ±Ø¹" disabled>
  <select id="rtype">
    <option>Ù…ÙˆØ§Ø¯</option><option>Ø£Ø¬Ù‡Ø²Ø©</option>
    <option>Ø®Ø¯Ù…Ø§Øª</option><option>ØµÙŠØ§Ù†Ø©</option>
  </select>
  <textarea id="desc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨"></textarea>
    <!-- ğŸ“ Ø±ÙØ¹ Ù…Ø±ÙÙ‚ Ù„Ù„Ø·Ù„Ø¨ -->
<input type="file" id="file" style="margin-top:10px">

<button class="btn" onclick="uploadAttachment()">ğŸ“ Ø±ÙØ¹ Ù…Ø±ÙÙ‚</button>
<button class="btn" onclick="showAttachments()">ğŸ“ Ø¹Ø±Ø¶ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨</button>

  <button class="btn" onclick="createReq()">Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

<div class="card">
  <h3>Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
  <table id="orders"><tbody></tbody></table>
</div>
<!-- ğŸ“¦ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¨ÙˆØ¨ Ø£Ø¨) -->
<div id="popup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.6);backdrop-filter:blur(3px);">
  <div style="background:#0f1b33;padding:20px;border-radius:12px;width:60%;margin:80px auto;
  color:white;max-height:70%;overflow:auto;">
    <h3>ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h3>
    <div id="attList"></div>
      <div id="previewArea" style="margin-top:15px;text-align:center;"></div>
    <button class="btn" onclick="closePopup()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script>
const API = "http://localhost:5000/api/employee";

async function createReq(){
  let user = JSON.parse(localStorage.getItem("user"));

  let form = new FormData();
  form.append("Ø§Ù„Ø±Ø§ÙØ¹", user.name);
  form.append("Ø§Ù„Ø¯ÙˆØ±", "Ù…ÙˆØ¸Ù");
  form.append("Ø§Ù„Ù‚Ø³Ù…", user.department);
  form.append("Ø§Ù„Ø´Ø±ÙƒØ©", user.company);
  form.append("Ø§Ù„ÙØ±Ø¹", user.branch);
  form.append("Ø§Ù„Ù†ÙˆØ¹", document.getElementById("rtype").value);
  form.append("Ø§Ù„ÙˆØµÙ", document.getElementById("desc").value);
  form.append("Ø§Ù„Ø­Ø§Ù„Ø©", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±");

  let res = await fetch("http://127.0.0.1:5000/api/employee/create", {
    method:"POST", body:form
  });

  let data = await res.json();
  alert("ğŸ“Œ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: " + data["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]);
  loadOrders(); // ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
}


async function loadOrders(){
  let user = JSON.parse(localStorage.getItem("user"));
  let res = await fetch(`${API}/my/${user.name}`);
  let data = await res.json();

  let rows = data.map(r => `
    <tr>
      <td>${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]}</td>
      <td>${r["Ø§Ù„Ù†ÙˆØ¹"]}</td>
      <td>${r["Ø§Ù„Ø­Ø§Ù„Ø©"]}</td>
      <td>${r["Ø§Ù„ÙˆØµÙ"]}</td>
    </tr>`).join("");

  document.querySelector("#orders tbody").innerHTML = rows;
}

async function uploadAttachment(){
    let file = document.getElementById("file").files[0]; // â† Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­
    if(!file){ alert("Ø§Ø®ØªØ± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹"); return; }

    let reqID = prompt("ğŸ“Œ Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù‡:");
    if(!reqID) return;

    let user = JSON.parse(localStorage.getItem("user"));

    let form = new FormData();
    form.append("file", file);
    form.append("Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨", reqID);
    form.append("Ø±Ø§ÙØ¹", user.name);
    form.append("Ø¯ÙˆØ±", user.role);
    form.append("Ø§Ù„Ù‚Ø³Ù…", user.department);
    form.append("Ø§Ù„Ø´Ø±ÙƒØ©", user.company);
    form.append("Ø§Ù„ÙØ±Ø¹", user.branch);

    let res = await fetch("http://127.0.0.1:5000/api/employee/upload", {
        method:"POST",
        body: form
    });

    let data = await res.json();
    alert(data.msg || "âœ”ï¸ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­");

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø±Ø©
    showAttachments(reqID);
}


async function showAttachments(){
  let reqID = prompt("Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:");
  if(!reqID) return;

  let res = await fetch(`${API}/attachments/${reqID}`);
  let files = await res.json();

  let html = "";
  if(files.length === 0){
    html = "<p style='text-align:center;color:#bbb'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</p>";
  } else {
    for(let f of files){
      html += `
<div style='padding:10px;border-bottom:1px solid #1a2b4a;margin-bottom:5px;'>
  <button onclick="previewFile('${f}')" style="background:none;border:0;color:#3b82f6;font-size:16px;cursor:pointer;">
    ğŸ“„ ${f}
  </button>
</div>`;

    }
  }

  document.getElementById("attList").innerHTML = html;
  document.getElementById("popup").style.display = "block";
}

function closePopup(){
  document.getElementById("popup").style.display = "none";
  document.getElementById("previewArea").innerHTML = ""; // ÙŠÙ…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
}


function logout(){ localStorage.clear(); location.reload(); }

// ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.addEventListener("DOMContentLoaded", () => {
  let user = JSON.parse(localStorage.getItem("user"));
  if(!user){
    location.href = "login.html";
    return;
  }

  document.getElementById("emp_name").value   = user.name;
  document.getElementById("emp_dept").value   = user.department;
  document.getElementById("emp_comp").value   = user.company;
  document.getElementById("emp_branch").value = user.branch;

  loadOrders();
});



    function previewFile(file){
  const BASE = "http://localhost:5000/uploads/";
  let ext = file.toLowerCase();
  let area = document.getElementById("previewArea");

  // ğŸ–¼ ØµÙˆØ±
  if (ext.endsWith(".png") || ext.endsWith(".jpg") || ext.endsWith(".jpeg") || ext.endsWith(".gif")) {
    area.innerHTML = `
      <img src="${BASE}${file}"
           style="max-width:100%;border-radius:10px;border:1px solid #1a2b4a;margin-top:10px;">
    `;
  }
  // ğŸ“„ Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰ (PDF, docx, ... Ø¥Ù„Ø®)
  else {
    area.innerHTML = `
      <iframe src="${BASE}${file}"
              style="width:100%;height:500px;border:none;margin-top:10px;border-radius:10px;"></iframe>
    `;
  }
}



</script>
</body>
</html>
