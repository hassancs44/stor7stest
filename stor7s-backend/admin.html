<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>STOR7S | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
body{font-family:Tajawal;background:#0b1220;color:#fff;margin:0;}
.topbar{background:#101d36;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.btn{background:#3b82f6;border:0;padding:10px 15px;border-radius:8px;color:#fff;cursor:pointer;margin-left:6px;}
.btn.green{background:#22c55e;}
.btn.red{background:#ef4444;}
.card{background:#0f1b33;padding:18px;border-radius:12px;margin:12px;}
input, textarea, select{
  width:100%;padding:10px;margin-top:6px;border-radius:8px;background:#162544;color:#fff;border:1px solid #243b55;
}
textarea{min-height:90px;resize:vertical;}
table{width:100%;border-collapse:collapse;margin-top:12px;overflow:hidden;border-radius:10px;}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);font-size:14px;vertical-align:top;}
th{background:rgba(255,255,255,.06);text-align:right;}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.tab{background:#162544;border:1px solid #243b55;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;}
.tab.active{background:#3b82f6;border-color:#3b82f6;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:900px){.grid{grid-template-columns:1fr;}}
hr{border:0;border-top:1px solid rgba(255,255,255,.1);margin:14px 0;}
.small{opacity:.8;font-size:13px}
</style>
</head>

<body>

<div class="topbar">
  <div>ğŸ› STOR7S | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
  <div>
    <button class="btn" onclick="refreshCurrent()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    <button class="btn red" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
<div class="card">
  <h2>ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)</h2>
  <div class="grid">
    <div>
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
      <select id="reqType">
        <option value="Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</option>
        <option value="Ø®Ø¯Ù…Ø©">Ø®Ø¯Ù…Ø©</option>
        <option value="Ø¹Ù‡Ø¯Ø©">Ø¹Ù‡Ø¯Ø©</option>
      </select>
    </div>
    <div>
      <label>Ø§Ù„Ù‚Ø³Ù…</label>
      <input id="reqDept" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©" />
      <div class="small">Ù„Ùˆ ØªØ±ÙƒØªÙ‡ ÙØ§Ø¶ÙŠØŒ Ø¨ÙŠØ§Ø®Ø° Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
    </div>
  </div>

  <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
  <textarea id="reqDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ ÙˆØ§Ø¶Ø­ Ù„Ù„Ø·Ù„Ø¨..."></textarea>


  <button class="btn green" onclick="createAdminRequest()">âœ… Ø¥Ù†Ø´Ø§Ø¡ + ØªØ¹Ù…ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
</div>

<!-- âœ… Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¥Ø´Ø±Ø§Ù -->
<div class="card">
  <h2>ğŸ“Œ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø¥Ø´Ø±Ø§Ù</h2>

  <div class="tabs">
    <div class="tab active" id="tab-requests" onclick="switchTab('requests')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    <div class="tab" id="tab-custody" onclick="switchTab('custody')">Ø§Ù„Ø¹Ù‡Ø¯</div>
    <div class="tab" id="tab-logs" onclick="switchTab('logs')">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
    <div class="tab" id="tab-approvals" onclick="switchTab('approvals')">Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª</div>
    <div class="tab" id="tab-purchase" onclick="switchTab('purchase')">Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡</div>
  </div>

  <input id="search" placeholder="Ø¨Ø­Ø« Ø¹Ø§Ù…..." onkeyup="filterTable()" />
  <div id="tableWrap"></div>
</div>

<script>
const API = "/api/admin";

// ==================== user from localStorage ====================
function getUser(){
  try{
    return JSON.parse(localStorage.getItem("user")||"{}");
  }catch(e){ return {}; }
}

// ==================== Tabs ====================
let CURRENT = "requests";

function switchTab(name){
  CURRENT = name;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById("tab-"+name).classList.add("active");
  document.getElementById("search").value = "";
  loadCurrent();
}

function refreshCurrent(){
  loadCurrent();
}

// ==================== Loaders ====================
async function loadCurrent(){
  if(CURRENT === "requests") return loadRequests();
  if(CURRENT === "custody") return loadCustody();
  if(CURRENT === "logs") return loadLogs();
  if(CURRENT === "approvals") return loadApprovals();
  if(CURRENT === "purchase") return loadPurchase();
}

async function loadRequests(){
  const res = await fetch(API+"/requests");
  const data = await res.json();

  let html = `
    <table id="table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ø±Ø§ÙØ¹</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(r=>{
    const state = (r.Ø§Ù„Ø­Ø§Ù„Ø©||"");
    const needApproval = (state === "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…");

    html += `
      <tr>
        <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨||"-"}</td>
        <td>${r.Ø§Ù„Ø±Ø§ÙØ¹||"-"}</td>
        <td>${r.Ø§Ù„Ù‚Ø³Ù…||"-"}</td>
        <td>${r.Ø§Ù„Ù†ÙˆØ¹||"-"}</td>
        <td>${state||"-"}</td>
        <td>
          ${needApproval
            ? `<button class="btn green" onclick="adminApprove('${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}')">ØªØ¹Ù…ÙŠØ¯ Ø¥Ø¯Ø§Ø±ÙŠ âœ”ï¸</button>`
            : "-"
          }
        </td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("tableWrap").innerHTML = html;
}

async function loadCustody(){
  const res = await fetch(API+"/custody");
  const data = await res.json();

  let html = `
    <table id="table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‡Ø¯Ø©</th><th>Ø³ÙŠØ±ÙŠØ§Ù„</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(r=>{
    html += `
      <tr>
        <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨||"-"}</td>
        <td>${r.Ø§Ù„Ù…ÙˆØ¸Ù||"-"}</td>
        <td>${r.Ù†ÙˆØ¹_Ø§Ù„Ø¹Ù‡Ø¯Ø©||"-"}</td>
        <td>${r.Ø³ÙŠØ±ÙŠØ§Ù„||"-"}</td>
        <td>${r.ØªØ§Ø±ÙŠØ®_Ø§Ù„ØªØ³Ù„ÙŠÙ…||"-"}</td>
        <td>${r.ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹||"-"}</td>
        <td>${r.Ø§Ù„Ø­Ø§Ù„Ø©||"-"}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("tableWrap").innerHTML = html;
}

async function loadLogs(){
  const res = await fetch(API+"/logs");
  const data = await res.json();

  let html = `
    <table id="table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ù…Ù†ÙØ°</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>ØªØ§Ø±ÙŠØ®</th><th>ÙˆÙ‚Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(r=>{
    html += `
      <tr>
        <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨||"-"}</td>
        <td>${r.Ø§Ù„Ø­Ø¯Ø«||"-"}</td>
        <td>${r.Ù…Ù†ÙØ°||"-"}</td>
        <td>${r.Ø§Ù„Ø¯ÙˆØ±||"-"}</td>
        <td>${r.Ø§Ù„ØªØ§Ø±ÙŠØ®||"-"}</td>
        <td>${r.Ø§Ù„ÙˆÙ‚Øª||"-"}</td>
        <td>${r.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||"-"}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("tableWrap").innerHTML = html;
}

async function loadApprovals(){
  const res = await fetch(API+"/approvals");
  const data = await res.json();

  let html = `
    <table id="table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¬Ù‡Ø©</th><th>Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</th><th>ØªØ§Ø±ÙŠØ®</th><th>ÙˆÙ‚Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(r=>{
    html += `
      <tr>
        <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨||"-"}</td>
        <td>${r.Ø§Ù„Ø¬Ù‡Ø©||"-"}</td>
        <td>${r.Ø§Ù„Ù…Ø¹ØªÙ…Ø¯||"-"}</td>
        <td>${r.Ø§Ù„ØªØ§Ø±ÙŠØ®||"-"}</td>
        <td>${r.Ø§Ù„ÙˆÙ‚Øª||"-"}</td>
        <td>${r.Ù…Ù„Ø§Ø­Ø¸Ø§Øª||"-"}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("tableWrap").innerHTML = html;
}

async function loadPurchase(){
  const res = await fetch(API+"/purchase");
  const data = await res.json();

  let html = `
    <table id="table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(r=>{
    html += `
      <tr>
        <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨||"-"}</td>
        <td>${r.Ø§Ù„Ù…ÙˆØ±Ø¯||"-"}</td>
        <td>${r.Ø§Ù„Ø³Ø¹Ø±||"-"}</td>
        <td>${r.Ø§Ù„ÙØ§ØªÙˆØ±Ø©||"-"}</td>
        <td>${r.ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙØ§ØªÙˆØ±Ø©||"-"}</td>
        <td>${r.Ø§Ù„Ø­Ø§Ù„Ø©||"-"}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("tableWrap").innerHTML = html;
}


// ==================== Create Admin Request ====================
async function createAdminRequest(){
  const u = getUser();

  const type = document.getElementById("reqType").value;
  const dept = document.getElementById("reqDept").value.trim() || (u.department || "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©");
  const desc = document.getElementById("reqDesc").value.trim();

  const payload = {
  name: u.name || "",
  role: u.role || "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©",
  department: dept,
  company: u.company || "",
  branch: u.branch || "",
  type: type,
  description: desc
};


  const res = await fetch(API+"/create_request",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const out = await res.json();
  if(!out.ok){
    alert("âŒ " + (out.msg || "Ø­Ø¯Ø« Ø®Ø·Ø£"));
    return;
  }

  alert("âœ… " + out.msg + " | Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: " + out.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨);
  document.getElementById("reqDesc").value = "";
  switchTab("requests");
}


// ==================== Admin Approve ====================
async function adminApprove(id){
  const u = getUser();
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ù…ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©ØŸ")) return;

  const res = await fetch(API+"/approve_request",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨: id,
      admin_name: u.name || "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©",
      note: "ØªØ¹Ù…ÙŠØ¯ Ø¥Ø¯Ø§Ø±ÙŠ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…)"
    })
  });

  const out = await res.json();
  if(!out.ok){
    alert("âŒ " + (out.msg || "ÙØ´Ù„ Ø§Ù„ØªØ¹Ù…ÙŠØ¯"));
    return;
  }

  alert("âœ”ï¸ " + out.msg);
  loadRequests();
}


// ==================== Search filter ====================
function filterTable(){
  const q = document.getElementById("search").value.toLowerCase();
  document.querySelectorAll("#table tbody tr").forEach(r=>{
    r.style.display = r.textContent.toLowerCase().includes(q) ? "" : "none";
  });
}

// ==================== Logout ====================
function logout(){ localStorage.clear(); location.href="login.html"; }

// Auto load
loadCurrent();
</script>

</body>
</html>
