<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>STOR7S | Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
body{
  font-family:Tajawal;
  background:#0b1220;
  color:#fff;
  margin:0;
  line-height:1.7;
  letter-spacing:.3px;
}

.topbar{background:#101d36;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.btn{
  background:#1d3b6b;
  border:0;
  padding:10px 18px;
  border-radius:8px;
  color:#fff;
  cursor:pointer;
  font-size:14px;
  transition:.2s;
}
.btn:hover{
  background:#24497e;
  transform:scale(.97);
}
.btn:active{
  transform:scale(.94);
}

.btn.red{background:#ef4444;}
.btn.green{background:#22c55e;}
.btn.yellow{background:#eab308;}
.card{
  background:#0f1b33;
  padding:25px;
  border-radius:14px;
  margin:15px;
  border:1px solid rgba(255,255,255,.05);
  box-shadow:0 4px 14px rgba(0,0,0,.35);
  transition:.2s;
}
.card:hover{
  border-color:rgba(255,255,255,.12);
}

input,select,textarea{width:100%;padding:10px;margin-top:5px;border-radius:8px;background:#162544;color:#fff;border:1px solid #243b55;}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  margin-top:15px;
}
th,td{
  padding:12px 14px;
  border-bottom:none;
  background:rgba(255,255,255,.03);
}
th{
  background:rgba(255,255,255,.07);
  font-weight:600;
}
tr:hover td{
  background:rgba(255,255,255,.08);
}

th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);}
nav{display:flex;gap:10px;margin:10px;}
nav button{flex:1;padding:15px;border-radius:8px;border:0;background:#101d36;color:#fff;cursor:pointer;}
nav button.active{background:#3b82f6;}
.hidden{display:none;}
</style>
</head>

<body>

<div class="topbar">
  <div>ğŸ“Œ STOR7S | Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</div>
  <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<nav>
  <button class="active" onclick="showTab('orders')">ğŸ“¥ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</button>
  <button onclick="showTab('warehouse')">ğŸ·ï¸ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</button>
</nav>

<!-- ========================= Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========================= -->
<div id="orders" class="card">
  <h3>ğŸ“¥ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªÙ†ÙÙŠØ°</h3>
  <button class="btn" onclick="loadOrders()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  <table id="ordersTable"><tbody></tbody></table>
</div>

<!-- ========================= Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ========================= -->
<div id="warehouse" class="card hidden">
  <h3>ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</h3>

  <h4>Ø¨Ø­Ø« / ÙÙ„Ø§ØªØ±</h4>
  <input id="searchItem" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ø§Ùˆ Ø§Ù„ÙƒÙˆØ¯" onkeyup="filterWarehouse()">

  <h4>â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹</h4>

<input id="w_code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)">
<input id="w_name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="w_cat"  placeholder="Ø§Ù„ÙØ¦Ø© (Ù…Ø«Ø§Ù„: Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª / Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª)">
<input id="w_qty"  type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
<input id="w_min"  type="number" placeholder="Ø­Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ (ØªÙ†Ø¨ÙŠÙ‡)">
<input id="w_loc"  placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø«Ø§Ù„: Ø±Ù A3 / Ù…Ø®Ø²Ù† 2)">
<select id="w_state">
  <option value="Ù…ØªØ§Ø­">Ù…ØªØ§Ø­</option>
  <option value="Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
  <option value="Ù…ÙÙ‚ÙˆØ¯ / ØªØ§Ù„Ù">Ù…ÙÙ‚ÙˆØ¯ / ØªØ§Ù„Ù</option>
</select>

<button class="btn green" onclick="addItem()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>


  <h4>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
  <table id="warehouseTable"><tbody></tbody></table>
</div>
<!-- ================== Modal Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ================== -->
<div id="actionModal" class="hidden"
style="position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.55);display:none;justify-content:center;align-items:center;z-index:9999;">
  <div style="
    background:#0f1b33;
    padding:28px;
    border-radius:12px;
    width:360px;
    text-align:center;
    border:1px solid rgba(255,255,255,.07);
    box-shadow:0 8px 30px rgba(0,0,0,.4);
  ">
    <h3 style="margin-bottom:18px;font-size:18px;">âš™ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… <span id="modalReq"></span></h3>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <button class="btn green" onclick="doIssue()">ğŸšš ØµØ±Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</button>
      <button class="btn yellow" onclick="doBuy()">ğŸ§¾ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</button>
      <button class="btn red" onclick="doIT()">ğŸ’» Ø¥Ø­Ø§Ù„Ø© Ù„Ù‚Ø³Ù… IT</button>
      <button class="btn" style="background:#444" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>


<script>
const API = "/api/purchasing";
const API_W = "http://localhost:5000/api/purchasing"; // Ù…Ø³ØªÙˆØ¯Ø¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù

// ================= TAB CONTROL =================
function showTab(id){
  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  event.currentTarget.classList.add("active");

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø¨
  if (id === "orders") {
    loadOrders();
  } else if (id === "warehouse") {
    loadWarehouse();
  }
}


// ================= Ø§Ù„Ø·Ù„Ø¨Ø§Øª =================
async function loadOrders(){
  let res = await fetch(API+"/approved");
  let data = await res.json();
  let rows="";
  for(let r of data){
    rows+=`
    <tr>
      <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}</td>
      <td>${r.Ø§Ù„ÙˆØµÙ||"-"}</td>
      <td>
  ${r.Ø§Ù„Ø­Ø§Ù„Ø© === "Ø£Ø¹ÙŠØ¯ Ù…Ù† IT"
    ? `<span style="color:#22c55e;font-weight:bold">
        âœ”ï¸ Ø¹Ø§Ø¯ Ù…Ù† ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
       </span>`
    : r.Ø§Ù„Ø­Ø§Ù„Ø©
  }

  ${r.Ø§Ù„Ø­Ø§Ù„Ø© === "Ø£Ø¹ÙŠØ¯ Ù…Ù† IT"
    ? `<button onclick="viewIT(${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨})">ğŸ“„ ØªÙ‚Ø±ÙŠØ± IT</button>`
    : ""
  }
</td>

      <td>
  <button class="btn" style="min-width:90px;text-align:center;" onclick="openAction(${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨})">âš™ï¸ Ø¥Ø¬Ø±Ø§Ø¡</button>
</td>
    </tr>`;
  }
  document.querySelector("#ordersTable tbody").innerHTML = rows;
}

// ğŸšš ØµØ±Ù Ù…Ø¨Ø§Ø´Ø±
async function issue(id){
  await fetch(API+"/issue",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨:id})
  });
  alert("âœ”ï¸ ØªÙ… Ø§Ù„ØµØ±Ù ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¹Ù‡Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
  loadOrders();
}

// ğŸ§¾ Ø´Ø±Ø§Ø¡
async function buy(id){
  await fetch(API+"/buy",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨:id})
  });
  alert("ğŸ§¾ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø´Ø±Ø§Ø¡");
  loadOrders();
}

// ğŸ” IT
async function forwardIT(id){
  await fetch(API+"/it",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨:id})
  });
  alert("ğŸ’» ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠØ©");
  loadOrders();
}

// ================= Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ =================
async function loadWarehouse(){
  let res = await fetch("/api/purchasing/warehouse");
  let data = await res.json();
  let rows = "";

  for(let i of data){
    let qty = parseInt(i.ÙƒÙ…ÙŠØ©_Ø­Ø§Ù„ÙŠØ§Ù‹ || 0);
    let min = parseInt(i.Ø­Ø¯_Ø¥Ø¹Ø§Ø¯Ø©_Ø§Ù„Ø·Ù„Ø¨ || 0);

    let color = "";
    if(qty === 0) color = "background:#7f1d1d";
    else if(qty <= min) color = "background:#78350f";

    rows += `
      <tr style="${color}">
        <td>${i.ÙƒÙˆØ¯}</td>
        <td>${i.Ø§Ø³Ù…}</td>
        <td>${i.ÙØ¦Ø©}</td>
        <td>${qty}</td>
        <td>${min}</td>
        <td>${i.Ø§Ù„Ù…ÙˆÙ‚Ø¹}</td>
        <td>${i.Ø§Ù„Ø­Ø§Ù„Ø©}</td>
      </tr>`;
  }

  document.querySelector("#warehouseTable tbody").innerHTML = rows;
}

function filterWarehouse(){
  let q = document.getElementById("searchItem").value.toLowerCase();
  document.querySelectorAll("#warehouseTable tbody tr").forEach(r=>{
    r.style.display = r.textContent.toLowerCase().includes(q)?"":"none";
  });
}

async function addItem(){
  let data = {
    ÙƒÙˆØ¯:  document.getElementById("w_code").value,
    Ø§Ø³Ù…:  document.getElementById("w_name").value,
    ÙØ¦Ø©:  document.getElementById("w_cat").value,
    ÙƒÙ…ÙŠØ©_Ø­Ø§Ù„ÙŠØ§Ù‹: document.getElementById("w_qty").value,
    Ø­Ø¯_Ø¥Ø¹Ø§Ø¯Ø©_Ø§Ù„Ø·Ù„Ø¨: document.getElementById("w_min").value,
    Ø§Ù„Ù…ÙˆÙ‚Ø¹: document.getElementById("w_loc").value,
    Ø§Ù„Ø­Ø§Ù„Ø©: document.getElementById("w_state").value,
  };

  let res = await fetch("/api/purchasing/warehouse/add", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });

  let r = await res.json();
  alert(r.msg);
  loadWarehouse();
}

function logout(){localStorage.clear();location.reload();}
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadOrders();
loadWarehouse();


    let currentReq = null;

function openAction(id){
  const row = [...document.querySelectorAll("#ordersTable tbody tr")]
    .find(r => r.textContent.includes(id));

  // Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ø±Ø§Ø¬Ø¹ Ù…Ù† IT Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ù‹Ø§
  if(row && row.textContent.includes("Ø¹Ø§Ø¯ Ù…Ù† ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª")){
    viewIT(id);
  }

  currentReq = id;
  document.getElementById("modalReq").innerText = id;
  document.getElementById("actionModal").style.display = "flex";
}


function closeModal(){
  document.getElementById("actionModal").style.display = "none";
  document.getElementById("actionModal").classList.add("hidden");
}

async function doIssue(){
  let res = await fetch(`${API}/items/${currentReq}`);
  let items = await res.json();

  if(items.length === 0){
    alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ù„Ø¨");
    return;
  }

  let options = items.map(i =>
    `${i.ÙƒÙˆØ¯} | ${i.Ø§Ø³Ù…} | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${i.ÙƒÙ…ÙŠØ©}`
  ).join("\n");

  let selected = prompt("Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù:\n" + options);
  if(!selected) return;

  let code = selected.split("|")[0].trim();
  let qty  = parseInt(prompt("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ ØµØ±ÙÙ‡Ø§:",1));

  let r = await fetch(`${API}/issue`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨: currentReq,
      ÙƒÙˆØ¯: code,
      ÙƒÙ…ÙŠØ©: qty
    })
  });

  let data = await r.json();
  alert(data.msg);
  closeModal();
  loadOrders();
  loadWarehouse();
}

async function doBuy(){
  const vendor = prompt("Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯:");
  const price  = prompt("Ø§Ù„Ø³Ø¹Ø±:");
  const invoice= prompt("Ø±Ù‚Ù…/Ù…Ø±Ø¬Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:");

  await fetch(`${API}/buy`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
          Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨: currentReq,
          Ø§Ù„Ù…ÙˆØ±Ø¯: vendor,
          Ø§Ù„Ø³Ø¹Ø±: price,
          Ø§Ù„ÙØ§ØªÙˆØ±Ø©: invoice
      })
  });
  alert("ğŸ§¾ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡");
  closeModal();
  loadOrders();
}

async function doIT(){
  await fetch(`${API}/it`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨: currentReq })
  });
  alert("ğŸ’» ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø³Ù… IT");
  closeModal();
  loadOrders();
}


async function action(type){
    await fetch(`${API}/${type}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨: currentReq })
    });
    alert("âœ”ï¸ ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
    closeModal();
    loadOrders();
}

async function viewIT(id){
  let res = await fetch(`/api/purchasing/it-report/${id}`);
  let data = await res.json();
  let r = data[0];

  alert(`
Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${r.Ù†ÙˆØ¹_Ø§Ù„ØªÙ‚ÙŠÙŠÙ…}
Ø§Ù„ØªÙˆØµÙŠØ©: ${r.Ø§Ù„ØªÙˆØµÙŠØ©}
Ø§Ù„ÙÙ†ÙŠ: ${r.Ø§Ø³Ù…_Ø§Ù„ÙÙ†ÙŠ}

${r.Ø§Ù„ÙˆØµÙ_Ø§Ù„ÙÙ†ÙŠ}
  `);
}

</script>
</body>
</html>
